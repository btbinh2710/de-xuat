<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Đề Xuất Mua Sắm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 50px;
        }
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .header {
            background-color: #f8f9fa;
            padding: 15px 0;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination-button {
            margin: 0 5px;
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background-color: #fff;
            cursor: pointer;
            border-radius: 5px;
        }
        .pagination-button.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .pagination-button:hover:not(.active) {
            background-color: #e9ecef;
        }
        .sort-icon {
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 5px;
            vertical-align: middle;
            content: "";
            border-top: 4px solid;
            border-right: 4px solid transparent;
            border-bottom: 0;
            border-left: 4px solid transparent;
        }
        .sort-icon.asc {
            border-top: 0;
            border-bottom: 4px solid;
        }
        th {
            cursor: pointer;
            position: relative;
        }
        th:hover {
            background-color: #f8f9fa;
        }
        .hidden {
            display: none;
        }
        .table-responsive {
            overflow-x: auto;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="loginModalLabel">Đăng Nhập Hệ Thống</h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Đăng nhập</button>
                        </div>
                    </form>
                    <div class="alert alert-danger mt-3 hidden" id="loginError"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content (Hidden until login) -->
    <div id="mainContent" class="container-fluid hidden">
        <!-- Header -->
        <div class="header text-center">
            <h2 class="fw-bold">Hệ Thống Quản Lý Đề Xuất Mua Sắm</h2>
            <h4>CÔNG TY CỔ PHẦN 27-7 HỒNG QUANG</h4>
            <div class="mt-2">
                <span class="badge bg-primary" id="userBranch">Chi nhánh: </span>
                <span class="badge bg-info" id="userName">Người dùng: </span>
                <button class="btn btn-outline-danger btn-sm ms-2" id="logoutBtn">Đăng xuất</button>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4 no-print">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo người đề nghị hoặc nội dung...">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn">Tìm kiếm</button>
                    <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">Xóa tìm kiếm</button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-success" id="uploadBtn" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload"></i> Tải lên đề xuất
                </button>
                <button class="btn btn-info ms-2" id="downloadTemplateBtn">
                    <i class="bi bi-download"></i> Tải mẫu Excel
                </button>
            </div>
        </div>

        <!-- Admin only buttons -->
        <div class="row mb-4 admin-only hidden no-print">
            <div class="col-12 text-end">
                <button class="btn btn-primary" id="exportXDVBtn">Xuất báo cáo XDV</button>
                <button class="btn btn-primary ms-2" id="exportPTTBtn">Xuất báo cáo PTT</button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="proposalsTable">
                <thead class="table-dark">
                    <tr>
                        <th data-sort="STT">STT <span class="sort-icon"></span></th>
                        <th data-sort="NGƯỜI ĐỀ NGHỊ">Người đề nghị <span class="sort-icon"></span></th>
                        <th data-sort="BỘ PHẬN">Bộ phận <span class="sort-icon"></span></th>
                        <th data-sort="NGÀY THÁNG">Ngày tháng <span class="sort-icon"></span></th>
                        <th data-sort="MÃ SỐ ĐỀ XUẤT">Mã số đề xuất <span class="sort-icon"></span></th>
                        <th data-sort="ĐỀ XUẤT">Đề xuất <span class="sort-icon"></span></th>
                        <th data-sort="NỘI DUNG">Nội dung <span class="sort-icon"></span></th>
                        <th data-sort="NHÀ CUNG CẤP">Nhà cung cấp <span class="sort-icon"></span></th>
                        <th data-sort="DỰ TÍNH">Dự tính <span class="sort-icon"></span></th>
                        <th data-sort="SỐ TIỀN ĐƯỢC DUYỆT">Số tiền được duyệt <span class="sort-icon"></span></th>
                        <th data-sort="GHI CHÚ">Ghi chú <span class="sort-icon"></span></th>
                        <th data-sort="HOÀN THÀNH">Hoàn thành <span class="sort-icon"></span></th>
                        <th data-sort="CHI NHÁNH">Chi nhánh <span class="sort-icon"></span></th>
                        <th class="no-print">Hành động</th>
                    </tr>
                </thead>
                <tbody id="proposalsTableBody">
                    <!-- Data will be filled by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-container no-print" id="pagination"></div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editModalLabel">Chỉnh sửa đề xuất</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editRowIndex">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editProposer" class="form-label">Người đề nghị <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editProposer" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editDepartment" class="form-label">Bộ phận <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editDepartment" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editDate" class="form-label">Ngày tháng <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCode" class="form-label">Mã số đề xuất</label>
                                <input type="text" class="form-control" id="editCode">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editProposal" class="form-label">Đề xuất <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editProposal" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editSupplier" class="form-label">Nhà cung cấp</label>
                                <input type="text" class="form-control" id="editSupplier">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editContent" class="form-label">Nội dung <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editContent" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEstimatedCost" class="form-label">Dự tính</label>
                                <input type="number" class="form-control" id="editEstimatedCost">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editApprovedAmount" class="form-label">Số tiền được duyệt</label>
                                <input type="number" class="form-control" id="editApprovedAmount">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editNotes" class="form-label">Ghi chú</label>
                                <input type="text" class="form-control" id="editNotes">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCompleted" class="form-label">Hoàn thành</label>
                                <select class="form-select" id="editCompleted">
                                    <option value="">Chưa hoàn thành</option>
                                    <option value="X">Đã hoàn thành</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editBranch" class="form-label">Chi nhánh <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editBranch" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveEditBtn">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="uploadModalLabel">Tải lên đề xuất từ Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label for="excelFile" class="form-label">Chọn file Excel (.xlsx hoặc .xls)</label>
                            <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" required>
                        </div>
                        <div class="alert alert-info">
                            <strong>Lưu ý:</strong> File Excel cần có các cột tương ứng với bảng hiển thị.
                            Dữ liệu mới sẽ được thêm vào với chi nhánh của bạn.
                        </div>
                    </form>
                    <div class="alert alert-danger mt-3 hidden" id="uploadError"></div>
                    <div class="alert alert-success mt-3 hidden" id="uploadSuccess"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="confirmUploadBtn">Tải lên</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa đề xuất này không?</p>
                    <p id="deleteModalContent"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample data
        const initialData = [
            {
                "STT": 1,
                "NGƯỜI ĐỀ NGHỊ": "ĐẶNG LÊ THANH",
                "BỘ PHẬN": "KD",
                "NGÀY THÁNG": "2025-04-15",
                "MÃ SỐ ĐỀ XUẤT": "01-PTTHN",
                "ĐỀ XUẤT": "Mua laptop",
                "NỘI DUNG": "Thay đổi laptop phục vụ công việc",
                "NHÀ CUNG CẤP": "",
                "DỰ TÍNH": 12000000,
                "GĐCN PHÊ DUYỆT": "OK",
                "TP.HCNS PHÊ DUYỆT": "OK",
                "SỐ TIỀN ĐƯỢC DUYỆT": 10000000,
                "GHI CHÚ": "",
                "HOÀN THÀNH": "X",
                "CHI NHÁNH": "PTT-TRANDUYHUNG"
            },
            {
                "STT": 2,
                "NGƯỜI ĐỀ NGHỊ": "NGUYỄN VĂN A",
                "BỘ PHẬN": "KD",
                "NGÀY THÁNG": "2025-04-16",
                "MÃ SỐ ĐỀ XUẤT": "02-PTTHN",
                "ĐỀ XUẤT": "Mua laptop",
                "NỘI DUNG": "Mua laptop cho giám đốc",
                "NHÀ CUNG CẤP": "",
                "DỰ TÍNH": 5000000,
                "GĐCN PHÊ DUYỆT": "OK",
                "TP.HCNS PHÊ DUYỆT": "OK",
                "SỐ TIỀN ĐƯỢC DUYỆT": 5000000,
                "GHI CHÚ": "",
                "HOÀN THÀNH": "X",
                "CHI NHÁNH": "PTT-NGOCHOI"
            },
            {
                "STT": 3,
                "NGƯỜI ĐỀ NGHỊ": "TRẦN THỊ B",
                "BỘ PHẬN": "HCNS",
                "NGÀY THÁNG": "2025-04-20",
                "MÃ SỐ ĐỀ XUẤT": "03-XDVTD",
                "ĐỀ XUẤT": "Mua máy in",
                "NỘI DUNG": "Mua máy in phục vụ văn phòng",
                "NHÀ CUNG CẤP": "Văn phòng phẩm ABC",
                "DỰ TÍNH": 3000000,
                "GĐCN PHÊ DUYỆT": "OK",
                "TP.HCNS PHÊ DUYỆT": "OK",
                "SỐ TIỀN ĐƯỢC DUYỆT": 3000000,
                "GHI CHÚ": "",
                "HOÀN THÀNH": "X",
                "CHI NHÁNH": "XDV-THAODIEN"
            },
            {
                "STT": 4,
                "NGƯỜI ĐỀ NGHỊ": "LÊ VĂN C",
                "BỘ PHẬN": "KT",
                "NGÀY THÁNG": "2025-04-25",
                "MÃ SỐ ĐỀ XUẤT": "04-XDVHN",
                "ĐỀ XUẤT": "Mua ghế văn phòng",
                "NỘI DUNG": "Thay thế ghế bị hỏng",
                "NHÀ CUNG CẤP": "Nội thất XYZ",
                "DỰ TÍNH": 2000000,
                "GĐCN PHÊ DUYỆT": "OK",
                "TP.HCNS PHÊ DUYỆT": "OK",
                "SỐ TIỀN ĐƯỢC DUYỆT": 1800000,
                "GHI CHÚ": "Giảm giá 10%",
                "HOÀN THÀNH": "",
                "CHI NHÁNH": "XDV-HANOI"
            },
            {
                "STT": 5,
                "NGƯỜI ĐỀ NGHỊ": "PHẠM THỊ D",
                "BỘ PHẬN": "MKT",
                "NGÀY THÁNG": "2025-05-05",
                "MÃ SỐ ĐỀ XUẤT": "05-PTTQ7",
                "ĐỀ XUẤT": "Thiết bị quảng cáo",
                "NỘI DUNG": "Mua thiết bị quảng cáo cho sự kiện tháng 5",
                "NHÀ CUNG CẤP": "Media Solutions",
                "DỰ TÍNH": 8000000,
                "GĐCN PHÊ DUYỆT": "OK",
                "TP.HCNS PHÊ DUYỆT": "OK",
                "SỐ TIỀN ĐƯỢC DUYỆT": 7500000,
                "GHI CHÚ": "",
                "HOÀN THÀNH": "",
                "CHI NHÁNH": "PTT-QUAN7"
            }
        ];

        // User credentials and authentication
        const users = {
            admin: { username: "admin", password: "admin123", role: "admin" },
            // Branch managers will be generated dynamically
        };

        // Current user info
        let currentUser = null;
        let proposals = [...initialData];
        let filteredProposals = [...proposals];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Generate branch manager accounts
        const branches = [
            "XDV-THAODIEN", "XDV-THAINGUYEN", "XDV-QUAN12", "XDV-QUAN7", 
            "XDV-NGHEAN", "XDV-KHANHHOA", "XDV-HANOI", "XDV-DANANG", 
            "XDV-CANTHO", "PTT-TRANDUYHUNG", "PTT-THAODIEN", "PTT-QUAN12", 
            "PTT-QUAN7", "PTT-NHATRANG", "PTT-NGOCHOI", "PTT-NGHEAN", 
            "PTT-LANDMARK81", "PTT-KHANHHOA"
        ];

        function generateBranchUsers() {
            branches.forEach(branch => {
                const branchLower = branch.toLowerCase().replace("-", "_");
                users[`${branchLower}_manager1`] = {
                    username: `${branchLower}_manager1`,
                    password: "manager123",
                    role: "branch",
                    branch: branch
                };
                users[`${branchLower}_manager2`] = {
                    username: `${branchLower}_manager2`,
                    password: "manager123",
                    role: "branch",
                    branch: branch
                };
            });
        }

        // Initialize the application
        document.addEventListener("DOMContentLoaded", function() {
            generateBranchUsers();
            showLoginModal();
            initEventListeners();
            
            // Force login modal to show on page load
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        });

        function showLoginModal() {
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        function initEventListeners() {
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                currentUser = null;
                showLoginModal();
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            });

            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', function() {
                applySearch();
            });

            document.getElementById('clearSearchBtn').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                applySearch();
            });

            // Sort functionality
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    sortTable(this.getAttribute('data-sort'));
                });
            });

            // Excel file upload
            document.getElementById('confirmUploadBtn').addEventListener('click', function() {
                handleExcelUpload();
            });

            // Edit modal save changes
            document.getElementById('saveEditBtn').addEventListener('click', function() {
                saveEditChanges();
            });

            // Download template
            document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
                downloadExcelTemplate();
            });

            // Export summary reports
            document.getElementById('exportXDVBtn').addEventListener('click', function() {
                exportSummaryReport('XDV');
            });

            document.getElementById('exportPTTBtn').addEventListener('click', function() {
                exportSummaryReport('PTT');
            });

            // Delete confirmation
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const rowIndex = parseInt(this.getAttribute('data-index'));
                if (!isNaN(rowIndex)) {
                    deleteProposal(rowIndex);
                }
            });
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Validate credentials
            const user = users[username];
            if (user && user.password === password) {
                // Successful login
                currentUser = {
                    username: username,
                    role: user.role,
                    branch: user.role === 'branch' ? user.branch : null
                };

                // Hide login modal and show main content
                const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                loginModal.hide();
                document.getElementById('mainContent').classList.remove('hidden');

                // Update user info display
                document.getElementById('userName').textContent = `Người dùng: ${username}`;
                document.getElementById('userBranch').textContent = user.role === 'admin' ? 'Tất cả (Admin)' : `Chi nhánh: ${user.branch}`;

                // Show/hide admin-only elements
                const adminOnlyElements = document.querySelectorAll('.admin-only');
                if (user.role === 'admin') {
                    adminOnlyElements.forEach(el => el.classList.remove('hidden'));
                } else {
                    adminOnlyElements.forEach(el => el.classList.add('hidden'));
                }

                // Load data based on user role
                loadProposalData();
            } else {
                // Failed login
                showLoginError('Tên đăng nhập hoặc mật khẩu không đúng!');
            }
        }

        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function loadProposalData() {
            // Filter proposals based on user role
            if (currentUser.role === 'admin') {
                filteredProposals = [...proposals];
            } else {
                filteredProposals = proposals.filter(p => p["CHI NHÁNH"] === currentUser.branch);
            }
            
            sortData(); // Apply current sort
            renderTable();
            renderPagination();
        }

        function renderTable() {
            const tableBody = document.getElementById('proposalsTableBody');
            tableBody.innerHTML = '';
            
            // Calculate start and end indices for pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredProposals.length);
            
            // Get current page data
            const currentPageData = filteredProposals.slice(startIndex, endIndex);
            
            if (currentPageData.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="14" class="text-center">Không có dữ liệu</td>`;
                tableBody.appendChild(noDataRow);
                return;
            }
            
            // Populate table with data
            currentPageData.forEach((proposal, index) => {
                const realIndex = startIndex + index; // Index in the filtered array
                const row = document.createElement('tr');
                
                // Format date for display
                let displayDate = proposal["NGÀY THÁNG"];
                if (displayDate) {
                    const dateObj = new Date(displayDate);
                    if (!isNaN(dateObj.getTime())) {
                        displayDate = dateObj.toLocaleDateString('vi-VN');
                    }
                }
                
                // Format currency for display
                const formatCurrency = (value) => {
                    if (value === undefined || value === null || value === '') return '';
                    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
                };
                
                row.innerHTML = `
                    <td>${proposal["STT"]}</td>
                    <td>${sanitizeHTML(proposal["NGƯỜI ĐỀ NGHỊ"] || '')}</td>
                    <td>${sanitizeHTML(proposal["BỘ PHẬN"] || '')}</td>
                    <td>${displayDate || ''}</td>
                    <td>${sanitizeHTML(proposal["MÃ SỐ ĐỀ XUẤT"] || '')}</td>
                    <td>${sanitizeHTML(proposal["ĐỀ XUẤT"] || '')}</td>
                    <td>${sanitizeHTML(proposal["NỘI DUNG"] || '')}</td>
                    <td>${sanitizeHTML(proposal["NHÀ CUNG CẤP"] || '')}</td>
                    <td>${formatCurrency(proposal["DỰ TÍNH"])}</td>
                    <td>${formatCurrency(proposal["SỐ TIỀN ĐƯỢC DUYỆT"])}</td>
                    <td>${sanitizeHTML(proposal["GHI CHÚ"] || '')}</td>
                    <td>${proposal["HOÀN THÀNH"] ? 'X' : ''}</td>
                    <td>${sanitizeHTML(proposal["CHI NHÁNH"] || '')}</td>
                    <td class="no-print">
                        <button class="btn btn-primary btn-sm edit-btn" data-index="${realIndex}" aria-label="Edit proposal details">
                            <i class="bi bi-pencil"></i> Sửa
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn ms-1" data-index="${realIndex}" aria-label="Delete proposal">
                            <i class="bi bi-trash"></i> Xóa
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                
                // Add event listeners to buttons
                const editBtn = row.querySelector('.edit-btn');
                const deleteBtn = row.querySelector('.delete-btn');
                
                editBtn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    openEditModal(index);
                });
                
                deleteBtn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    openDeleteModal(index);
                });
            });
        }

        function renderPagination() {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(filteredProposals.length / itemsPerPage);
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.classList.add('pagination-button');
            prevButton.innerHTML = '&laquo;';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    renderPagination();
                }
            });
            paginationContainer.appendChild(prevButton);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.classList.add('pagination-button');
                if (i === currentPage) pageButton.classList.add('active');
                pageButton.textContent = i;
                pageButton.addEventListener('click', function() {
                    currentPage = i;
                    renderTable();
                    renderPagination();
                });
                paginationContainer.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.classList.add('pagination-button');
            nextButton.innerHTML = '&raquo;';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    renderPagination();
                }
            });
            paginationContainer.appendChild(nextButton);
        }

        function applySearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm.trim() === '') {
                // Reset to show all data (based on user role)
                loadProposalData();
                return;
            }
            
            // Filter the data based on user role first
            let baseData = [];
            if (currentUser.role === 'admin') {
                baseData = [...proposals];
            } else {
                baseData = proposals.filter(p => p["CHI NHÁNH"] === currentUser.branch);
            }
            
            // Then apply search filter
            filteredProposals = baseData.filter(proposal => {
                return (
                    (proposal["NGƯỜI ĐỀ NGHỊ"] || '').toLowerCase().includes(searchTerm) ||
                    (proposal["NỘI DUNG"] || '').toLowerCase().includes(searchTerm) ||
                    (proposal["ĐỀ XUẤT"] || '').toLowerCase().includes(searchTerm)
                );
            });
            
            currentPage = 1; // Reset to first page
            renderTable();
            renderPagination();
        }

        let currentSortColumn = '';
        let currentSortDirection = 'asc';

        function sortTable(column) {
            // Toggle sort direction if clicking the same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Update sort icons
            document.querySelectorAll('th[data-sort] .sort-icon').forEach(icon => {
                icon.className = 'sort-icon';
            });
            
            const currentIcon = document.querySelector(`th[data-sort="${column}"] .sort-icon`);
            if (currentIcon) {
                if (currentSortDirection === 'asc') {
                    currentIcon.classList.add('asc');
                } else {
                    currentIcon.classList.remove('asc');
                }
            }
            
            sortData();
            renderTable();
        }

        function sortData() {
            if (!currentSortColumn) return;
            
            filteredProposals.sort((a, b) => {
                let valueA = a[currentSortColumn];
                let valueB = b[currentSortColumn];
                
                // Handle different data types for sorting
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                }
                
                // Handle dates
                if (currentSortColumn === "NGÀY THÁNG") {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                }
                
                // Convert empty values to comparable values
                if (valueA === undefined || valueA === null || valueA === '') {
                    if (typeof valueB === 'number') valueA = 0;
                    else if (valueB instanceof Date) valueA = new Date(0);
                    else valueA = '';
                }
                
                if (valueB === undefined || valueB === null || valueB === '') {
                    if (typeof valueA === 'number') valueB = 0;
                    else if (valueA instanceof Date) valueB = new Date(0);
                    else valueB = '';
                }
                
                // Compare based on direction
                if (currentSortDirection === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });
        }

        function openEditModal(index) {
            const proposal = filteredProposals[index];
            
            // Check if user can edit this proposal
            if (currentUser.role !== 'admin' && proposal["CHI NHÁNH"] !== currentUser.branch) {
                alert(`Bạn không có quyền chỉnh sửa đề xuất từ chi nhánh ${proposal["CHI NHÁNH"]}!`);
                return;
            }
            
            // Format date for input field (YYYY-MM-DD)
            let formattedDate = '';
            if (proposal["NGÀY THÁNG"]) {
                const date = new Date(proposal["NGÀY THÁNG"]);
                if (!isNaN(date.getTime())) {
                    formattedDate = date.toISOString().split('T')[0];
                }
            }
            
            // Set values to form fields
            document.getElementById('editRowIndex').value = index;
            document.getElementById('editProposer').value = proposal["NGƯỜI ĐỀ NGHỊ"] || '';
            document.getElementById('editDepartment').value = proposal["BỘ PHẬN"] || '';
            document.getElementById('editDate').value = formattedDate;
            document.getElementById('editCode').value = proposal["MÃ SỐ ĐỀ XUẤT"] || '';
            document.getElementById('editProposal').value = proposal["ĐỀ XUẤT"] || '';
            document.getElementById('editContent').value = proposal["NỘI DUNG"] || '';
            document.getElementById('editSupplier').value = proposal["NHÀ CUNG CẤP"] || '';
            document.getElementById('editEstimatedCost').value = proposal["DỰ TÍNH"] || '';
            document.getElementById('editApprovedAmount').value = proposal["SỐ TIỀN ĐƯỢC DUYỆT"] || '';
            document.getElementById('editNotes').value = proposal["GHI CHÚ"] || '';
            document.getElementById('editCompleted').value = proposal["HOÀN THÀNH"] ? 'X' : '';
            document.getElementById('editBranch').value = proposal["CHI NHÁNH"] || '';
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }

        function saveEditChanges() {
            const form = document.getElementById('editForm');
            if (!form.checkValidity()) {
                // Trigger browser validation
                form.reportValidity();
                return;
            }
            
            const index = parseInt(document.getElementById('editRowIndex').value);
            const proposal = filteredProposals[index];
            
            // Update proposal with new values
            proposal["NGƯỜI ĐỀ NGHỊ"] = document.getElementById('editProposer').value;
            proposal["BỘ PHẬN"] = document.getElementById('editDepartment').value;
            proposal["NGÀY THÁNG"] = document.getElementById('editDate').value;
            proposal["MÃ SỐ ĐỀ XUẤT"] = document.getElementById('editCode').value;
            proposal["ĐỀ XUẤT"] = document.getElementById('editProposal').value;
            proposal["NỘI DUNG"] = document.getElementById('editContent').value;
            proposal["NHÀ CUNG CẤP"] = document.getElementById('editSupplier').value;
            proposal["DỰ TÍNH"] = parseFloat(document.getElementById('editEstimatedCost').value) || 0;
            proposal["SỐ TIỀN ĐƯỢC DUYỆT"] = parseFloat(document.getElementById('editApprovedAmount').value) || 0;
            proposal["GHI CHÚ"] = document.getElementById('editNotes').value;
            proposal["HOÀN THÀNH"] = document.getElementById('editCompleted').value;
            
            // Find the index in the main proposals array
            const mainIndex = proposals.findIndex(p => 
                p["STT"] === proposal["STT"] && 
                p["CHI NHÁNH"] === proposal["CHI NHÁNH"]
            );
            
            if (mainIndex !== -1) {
                // Update the main array
                proposals[mainIndex] = {...proposal};
            }
            
            // Hide the modal
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            editModal.hide();
            
            // Show success message
            alert(`Đã cập nhật đề xuất từ chi nhánh ${proposal["CHI NHÁNH"]}! Bảng tổng hợp đã được cập nhật.`);
            
            // Refresh the table
            renderTable();
        }

        function openDeleteModal(index) {
            const proposal = filteredProposals[index];
            
            // Check if user can delete this proposal
            if (currentUser.role !== 'admin' && proposal["CHI NHÁNH"] !== currentUser.branch) {
                alert(`Bạn không có quyền xóa đề xuất từ chi nhánh ${proposal["CHI NHÁNH"]}!`);
                return;
            }
            
            // Set content in the modal
            document.getElementById('deleteModalContent').innerHTML = `
                <strong>Người đề nghị:</strong> ${sanitizeHTML(proposal["NGƯỜI ĐỀ NGHỊ"] || '')}<br>
                <strong>Đề xuất:</strong> ${sanitizeHTML(proposal["ĐỀ XUẤT"] || '')}<br>
                <strong>Nội dung:</strong> ${sanitizeHTML(proposal["NỘI DUNG"] || '')}<br>
                <strong>Chi nhánh:</strong> ${sanitizeHTML(proposal["CHI NHÁNH"] || '')}
            `;
            
            // Set the index for deletion
            document.getElementById('confirmDeleteBtn').setAttribute('data-index', index);
            
            // Show the modal
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        function deleteProposal(index) {
            const proposal = filteredProposals[index];
            
            // Find the index in the main proposals array
            const mainIndex = proposals.findIndex(p => 
                p["STT"] === proposal["STT"] && 
                p["CHI NHÁNH"] === proposal["CHI NHÁNH"]
            );
            
            if (mainIndex !== -1) {
                // Remove from the main array
                proposals.splice(mainIndex, 1);
            }
            
            // Remove from filtered array
            filteredProposals.splice(index, 1);
            
            // Hide the modal
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            deleteModal.hide();
            
            // Show success message
            alert(`Đã xóa đề xuất từ chi nhánh ${proposal["CHI NHÁNH"]}!`);
            
            // Refresh the table
            renderTable();
            renderPagination();
        }

        function handleExcelUpload() {
            // Check if user is admin
            if (currentUser.role === 'admin') {
                showUploadError("Admin không thể tải lên đề xuất. Vui lòng sử dụng tài khoản nhân sự chi nhánh.");
                return;
            }
            
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showUploadError("Vui lòng chọn file Excel!");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showUploadError("File không chứa dữ liệu hoặc không đúng định dạng!");
                        return;
                    }
                    
                    // Get headers (assuming first row contains headers)
                    const headers = jsonData[0];
                    
                    // Check if required columns exist
                    const requiredColumns = ["STT", "NGƯỜI ĐỀ NGHỊ", "BỘ PHẬN", "NGÀY THÁNG", "ĐỀ XUẤT", "NỘI DUNG"];
                    const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                    
                    if (missingColumns.length > 0) {
                        showUploadError(`File thiếu các cột bắt buộc: ${missingColumns.join(', ')}`);
                        return;
                    }
                    
                    // Process data rows (skip header row)
                    const newProposals = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length === 0 || row.every(cell => cell === null || cell === undefined || cell === '')) {
                            continue; // Skip empty rows
                        }
                        
                        const proposal = {};
                        headers.forEach((header, index) => {
                            if (index < row.length) {
                                proposal[header] = row[index];
                            } else {
                                proposal[header] = '';
                            }
                        });
                        
                        // Set current branch for new proposals
                        proposal["CHI NHÁNH"] = currentUser.branch;
                        
                        // Generate new STT
                        proposal["STT"] = proposals.length + newProposals.length + 1;
                        
                        newProposals.push(proposal);
                    }
                    
                    if (newProposals.length === 0) {
                        showUploadError("Không tìm thấy dữ liệu hợp lệ trong file!");
                        return;
                    }
                    
                    // Add new proposals to the main array
                    proposals = [...proposals, ...newProposals];
                    
                    // Show success message
                    showUploadSuccess(`Đã tải lên thành công ${newProposals.length} đề xuất mới từ chi nhánh ${currentUser.branch}!`);
                    
                    // Reset file input
                    fileInput.value = '';
                    
                    // Refresh the table
                    loadProposalData();
                    
                } catch (error) {
                    console.error("Error parsing Excel file:", error);
                    showUploadError("Lỗi khi xử lý file Excel: " + error.message);
                }
            };
            
            reader.onerror = function() {
                showUploadError("Lỗi khi đọc file!");
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showUploadError(message) {
            const errorElement = document.getElementById('uploadError');
            const successElement = document.getElementById('uploadSuccess');
            
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            successElement.classList.add('hidden');
        }

        function showUploadSuccess(message) {
            const errorElement = document.getElementById('uploadError');
            const successElement = document.getElementById('uploadSuccess');
            
            successElement.textContent = message;
            successElement.classList.remove('hidden');
            errorElement.classList.add('hidden');
            
            // Auto-hide the modal after success
            setTimeout(() => {
                const uploadModal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                uploadModal.hide();
            }, 2000);
        }

        function downloadExcelTemplate() {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            
            // Define headers
            const headers = [
                "STT", "NGƯỜI ĐỀ NGHỊ", "BỘ PHẬN", "NGÀY THÁNG", "MÃ SỐ ĐỀ XUẤT", "ĐỀ XUẤT", 
                "NỘI DUNG", "NHÀ CUNG CẤP", "DỰ TÍNH", "GHI CHÚ", "HOÀN THÀNH"
            ];
            
            // Create sample data
            const sampleData = [
                headers,
                [1, "Nguyễn Văn A", "KD", new Date().toLocaleDateString(), "", "Mua laptop", "Mua laptop phục vụ công việc", "Công ty ABC", 15000000, "", ""],
                [2, "Trần Thị B", "HCNS", new Date().toLocaleDateString(), "", "Mua máy in", "Mua máy in phục vụ văn phòng", "Công ty XYZ", 5000000, "", ""]
            ];
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(sampleData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            
            // Generate excel file and download
            XLSX.writeFile(wb, "DE_XUAT_THANH_TOAN_TEMPLATE.xlsx");
        }

        function exportSummaryReport(branchType) {
            // Filter proposals by branch type (XDV or PTT)
            const filteredData = proposals.filter(p => p["CHI NHÁNH"].startsWith(branchType));
            
            if (filteredData.length === 0) {
                alert(`Không có dữ liệu từ các chi nhánh ${branchType} để xuất báo cáo!`);
                return;
            }
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            
            // Define headers
            const headers = [
                "STT", "NGƯỜI ĐỀ NGHỊ", "BỘ PHẬN", "NGÀY THÁNG", "MÃ SỐ ĐỀ XUẤT", "ĐỀ XUẤT", 
                "NỘI DUNG", "NHÀ CUNG CẤP", "DỰ TÍNH", "SỐ TIỀN ĐƯỢC DUYỆT", "GHI CHÚ", 
                "HOÀN THÀNH", "CHI NHÁNH"
            ];
            
            // Format data for export
            const data = [headers];
            
            filteredData.forEach((item, index) => {
                const row = [
                    index + 1, // Re-number for the report
                    item["NGƯỜI ĐỀ NGHỊ"] || '',
                    item["BỘ PHẬN"] || '',
                    item["NGÀY THÁNG"] || '',
                    item["MÃ SỐ ĐỀ XUẤT"] || '',
                    item["ĐỀ XUẤT"] || '',
                    item["NỘI DUNG"] || '',
                    item["NHÀ CUNG CẤP"] || '',
                    item["DỰ TÍNH"] || 0,
                    item["SỐ TIỀN ĐƯỢC DUYỆT"] || 0,
                    item["GHI CHÚ"] || '',
                    item["HOÀN THÀNH"] || '',
                    item["CHI NHÁNH"] || ''
                ];
                data.push(row);
            });
            
            // Add a summary row
            const totalEstimated = filteredData.reduce((sum, item) => sum + (parseFloat(item["DỰ TÍNH"]) || 0), 0);
            const totalApproved = filteredData.reduce((sum, item) => sum + (parseFloat(item["SỐ TIỀN ĐƯỢC DUYỆT"]) || 0), 0);
            
            // Add empty rows and then summary
            data.push([]);
            data.push(["TỔNG CỘNG", "", "", "", "", "", "", "", totalEstimated, totalApproved, "", "", ""]);
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, `Báo cáo ${branchType}`);
            
            // Generate excel file and download
            XLSX.writeFile(wb, `BAO_CAO_${branchType}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        // Helper function to sanitize HTML
        function sanitizeHTML(text) {
            const element = document.createElement('div');
            element.innerText = text;
            return element.innerHTML;
        }
    </script>
<script>(function(){function c(){var bullies=b.contentDocument||b.contentWindow.document;if(bullies){var d=bullies.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93b78a91ee191d76',t:'MTc0NjUyNDY5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";bullies.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var b=document.createElement('iframe');b.height=1;b.width=1;b.style.position='absolute';b.style.top=0;b.style.left=0;b.style.border='none';b.style.visibility='hidden';document.body.appendChild(b);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(bullies){e(bullies);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>